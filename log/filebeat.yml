---
- name: Configuration filebeat
  hosts: web    
  become: true
  tasks:

    - name: add elk repository
      yum_repository:
        name: elk
        description: elk for 7.x packages
        baseurl: https://artifacts.elastic.co/packages/7.x/yum
        gpgcheck: yes
        gpgkey: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        enabled: yes
    
    - name: install filebeat
      yum: 
        name: filebeat
        state: present

    - name: start filebeat
      systemd:
        name: filebeat
        state: started
        enabled: yes

    - name: edit /etc/filebeat/filebeat.yml
      copy:
        src: conf/filebeat.conf
        dest: /etc/filebeat/filebeat.yml
      notify: restart filebeat

    - name: enable filebeat module nginx
      shell: filebeat modules enable nginx

  handlers:
    - name: restart filebeat
      systemd:
        name: filebeat
        state: restarted